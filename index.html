<html><head><base href="." />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restaurant Traffic Analysis</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .chart-container {
        height: 400px;
        margin-top: 20px;
    }
    .pie-charts-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    .pie-chart-container {
        flex: 1;
        height: 300px;
        position: relative;
    }
    h1, h2 {
        color: #333;
        text-align: center;
    }
    .controls {
        display: flex;
        gap: 20px;
        margin: 20px 0;
        justify-content: center;
        flex-wrap: wrap;
    }
    select, input {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    .date-selector {
        text-align: center;
        margin: 20px 0;
    }
    #datePicker {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        width: 200px;
        text-align: center;
    }
    .tab-container {
        width: 100%;
        margin-top: 20px;
    }
    .tab-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 10px 20px;
        background: #f5f5f5;
        border: 2px solid #2f7622;
        border-radius: 4px;
        cursor: pointer;
        color: #2f7622;
        font-weight: bold;
    }
    .tab-button.active {
        background: #2f7622;
        color: white;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
    }
    #column2 {
        transition: opacity 0.3s;
    }
    #column2.hidden {
        display: none;
    }
</style>
</head>
<body>
    <h1>Restaurant Traffic Analysis</h1>

    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="daily">Daily Overview</button>
            <button class="tab-button" data-tab="hourly">Hourly Analysis</button>
            <button class="tab-button" data-tab="weekday">Weekday Analysis</button>
        </div>
        
        <div id="dailyTab" class="tab-content active">
            <div class="container">
                <h2>Daily Overview</h2>
                <div class="chart-container">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>
        </div>

        <div id="hourlyTab" class="tab-content">
            <div class="container">
                <h2>Hourly Analysis</h2>
                <div class="date-selector">
                    <input type="text" id="datePicker" placeholder="Select Date">
                </div>
                <div class="controls">
                    <select id="column1">
                        <option value="Customers">Customers Entering</option>
                        <option value="CustomersOUT">Customers Leaving</option>
                        <option value="Men">Men Entering</option>
                        <option value="MenOUT">Men Leaving</option>
                        <option value="Women">Women Entering</option>
                        <option value="WomenOUT">Women Leaving</option>
                        <option value="Group">Group Entering</option>
                        <option value="GroupOUT">Group Leaving</option>
                        <option value="Passersby">Passersby</option>
                        <option value="CaptureRate">Capture Rate (%)</option>
                    </select>
                    <label class="checkbox-label">
                        <input type="checkbox" id="showSecondCategory"> 
                        Benchmark
                    </label>
                    <select id="column2">
                        <option value="Passersby">Passersby</option>
                        <option value="Customers">Customers Entering</option>
                        <option value="CustomersOUT">Customers Leaving</option>
                        <option value="Men">Men Entering</option>
                        <option value="MenOUT">Men Leaving</option>
                        <option value="Women">Women Entering</option>
                        <option value="WomenOUT">Women Leaving</option>
                        <option value="Group">Group Entering</option>
                        <option value="GroupOUT">Group Leaving</option>
                        <option value="CaptureRate">Capture Rate (%)</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
                <div class="pie-charts-container">
                    <div class="pie-chart-container">
                        <canvas id="genderPieChart"></canvas>
                    </div>
                    <div class="pie-chart-container">
                        <canvas id="timeCapturePieChart"></canvas>
                        <div class="time-range-selector" style="margin-top: 10px; text-align: center;">
                            <label>Custom Time Range:</label><br>
                            <input type="range" id="startHourRange" min="0" max="23" value="11" style="width: 120px">
                            <input type="range" id="endHourRange" min="0" max="23" value="15" style="width: 120px"><br>
                            <span id="customTimeRange">11:00 - 15:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="weekdayTab" class="tab-content">
            <div class="container">
                <h2>Weekday Average Analysis</h2>
                <div class="controls">
                    <select id="weekdaySelect">
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                        <option value="0">Sunday</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="weekdayChart"></canvas>
                </div>
            </div>
        </div>
    </div>

<script>
let rawData = [];
let flatpickrInstance;
let hourlyChart = null;
let genderPieChart = null;
let timeCaptureChart = null;

const columnMap = {
    'Customers': 1,
    'CustomersOUT': 2,
    'Men': 3,
    'MenOUT': 4,
    'Women': 5,
    'WomenOUT': 6,
    'Group': 7,
    'GroupOUT': 8,
    'Passersby': 9
};

function calculateCaptureRate(customers, passersby) {
    if (passersby === 0) return 0;
    return (customers / passersby * 100).toFixed(1);
}

function getDateColor(dateStr) {
    if (!dateStr || typeof dateStr !== 'string') return '#000000';
    
    const parts = dateStr.split('/');
    if (parts.length !== 3) return '#000000';
    
    const [day, month, year] = parts;
    const date = new Date(year, month - 1, day);
    let dayOfWeek = date.getDay() || 7;

    if (dayOfWeek === 6) return '#2f7622'; // Saturday
    if (dayOfWeek === 7) return '#f39700'; // Sunday
    return '#000000'; // Weekday
}

function getWeekNumber(date) {
    const target = new Date(date);
    target.setDate(target.getDate() + 4 - (target.getDay() || 7));
    const yearStart = new Date(target.getFullYear(), 0, 1);
    const weekNum = Math.ceil((((target - yearStart) / 86400000) + 1) / 7);
    return weekNum;
}

function getValue(column, row) {
    const customers = parseInt(row[columnMap['Customers']]) || 0;
    const passersby = parseInt(row[columnMap['Passersby']]) || 0;
    const menEntering = parseInt(row[columnMap['Men']]) || 0;
    const womenEntering = parseInt(row[columnMap['Women']]) || 0;
    const menLeaving = parseInt(row[columnMap['MenOUT']]) || 0;
    const womenLeaving = parseInt(row[columnMap['WomenOUT']]) || 0;

    const totalGender = menEntering + womenEntering;
    const adjustedMenEntering = totalGender > 0 ? customers * (menEntering / totalGender) : 0;
    const adjustedWomenEntering = totalGender > 0 ? customers * (womenEntering / totalGender) : 0;
    
    const totalGenderOut = menLeaving + womenLeaving;
    const adjustedMenLeaving = totalGenderOut > 0 ? customers * (menLeaving / totalGenderOut) : 0;
    const adjustedWomenLeaving = totalGenderOut > 0 ? customers * (womenLeaving / totalGenderOut) : 0;

    switch(column) {
        case 'Men': return adjustedMenEntering;
        case 'MenOUT': return adjustedMenLeaving;
        case 'Women': return adjustedWomenEntering;
        case 'WomenOUT': return adjustedWomenLeaving;
        case 'CaptureRate': return calculateCaptureRate(customers, passersby);
        case 'Customers': return customers;
        case 'CustomersOUT': return parseInt(row[columnMap['CustomersOUT']]) || 0;
        case 'Group': return parseInt(row[columnMap['Group']]) || 0;
        case 'GroupOUT': return parseInt(row[columnMap['GroupOUT']]) || 0;
        case 'Passersby': return passersby;
        default: return 0;
    }
}

function calculateTimeRangeCapture(data, startHour, endHour) {
    let totalCustomers = 0;
    let totalPassersby = 0;

    data.forEach(row => {
        const hour = new Date(row[0]).getHours();
        if (hour >= startHour && hour <= endHour) {
            totalCustomers += parseInt(row[columnMap['Customers']]) || 0;
            totalPassersby += parseInt(row[columnMap['Passersby']]) || 0;
        }
    });

    return {
        customers: totalCustomers,
        passersby: totalPassersby,
        rate: calculateCaptureRate(totalCustomers, totalPassersby)
    };
}

function updateTimeCaptureChart(selectedDate) {
    const [day, month, year] = selectedDate.split('/');
    const dailyData = rawData.filter(row => {
        const date = new Date(row[0]);
        const datePart = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        return datePart === selectedDate;
    });

    const morningCapture = calculateTimeRangeCapture(dailyData, 7, 10);
    const noonCapture = calculateTimeRangeCapture(dailyData, 12, 14);
    const afternoonCapture = calculateTimeRangeCapture(dailyData, 16, 20);
    
    const startHour = parseInt(document.getElementById('startHourRange').value);
    const endHour = parseInt(document.getElementById('endHourRange').value);
    const customCapture = calculateTimeRangeCapture(dailyData, startHour, endHour);

    const ctx = document.getElementById('timeCapturePieChart').getContext('2d');
    if (timeCaptureChart instanceof Chart) {
        timeCaptureChart.destroy();
    }

    timeCaptureChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: [
                `Morning (7-10): ${morningCapture.rate}%`,
                `Noon (12-14): ${noonCapture.rate}%`,
                `Afternoon (16-20): ${afternoonCapture.rate}%`,
                `Custom (${startHour}:00-${endHour}:00): ${customCapture.rate}%`
            ],
            datasets: [{
                data: [
                    morningCapture.rate,
                    noonCapture.rate,
                    afternoonCapture.rate,
                    customCapture.rate
                ],
                backgroundColor: [
                    '#2f7622',
                    '#f39700',
                    '#c5d469',
                    '#af9e50'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Capture Rate by Time Period'
                },
                legend: {
                    position: 'bottom'
                },
                datalabels: {
                    formatter: (value) => {
                        return value.toFixed(1) + '%';
                    },
                    color: '#fff',
                    font: {
                        weight: 'bold'
                    }
                }
            }
        }
    });
}

async function loadInitialData() {
    try {
        console.log('Loading data from GitHub...');
        const response = await fetch('https://raw.githubusercontent.com/JFTHIBAUT/Ex/main/xxdata.csv');
        if (!response.ok) {
            throw new Error('Failed to fetch CSV from GitHub');
        }
        const csvData = await response.text();
        
        rawData = csvData.split('\n')
            .filter(line => line.trim() !== '')
            .map(line => line.split(';'));
        
        rawData.shift();
        
        createDailyChart();
        
        const availableDates = [...new Set(rawData.map(row => {
            const date = new Date(row[0]);
            return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        }))];
        if (availableDates.length > 0) {
            const firstDate = availableDates[0];
            if (flatpickrInstance) {
                flatpickrInstance.setDate(firstDate);
                updateHourlyChart();
            }
        }
        
        updateWeekdayChart();
        
        console.log('Data loaded from GitHub successfully!');
    } catch (error) {
        console.error('Error loading GitHub data:', error);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    flatpickrInstance = flatpickr("#datePicker", {
        dateFormat: "d/m/Y",
        onChange: function(selectedDates) {
            if (selectedDates.length > 0) {
                updateHourlyChart();
            }
        }
    });

    document.getElementById('column1').addEventListener('change', updateHourlyChart);
    document.getElementById('column2').addEventListener('change', updateHourlyChart);
    document.getElementById('weekdaySelect').addEventListener('change', updateWeekdayChart);
    
    document.getElementById('showSecondCategory').addEventListener('change', function(e) {
        const column2Select = document.getElementById('column2');
        column2Select.classList.toggle('hidden', !e.target.checked);
        updateHourlyChart();
    });

    document.getElementById('startHourRange').addEventListener('input', function() {
        const startHour = parseInt(this.value);
        const endHour = parseInt(document.getElementById('endHourRange').value);
        if (startHour >= endHour) {
            document.getElementById('endHourRange').value = startHour + 1;
        }
        document.getElementById('customTimeRange').textContent = 
            `${startHour}:00 - ${document.getElementById('endHourRange').value}:00`;
        updateTimeCaptureChart(document.getElementById('datePicker').value);
    });

    document.getElementById('endHourRange').addEventListener('input', function() {
        const endHour = parseInt(this.value);
        const startHour = parseInt(document.getElementById('startHourRange').value);
        if (endHour <= startHour) {
            document.getElementById('startHourRange').value = endHour - 1;
        }
        document.getElementById('customTimeRange').textContent = 
            `${document.getElementById('startHourRange').value}:00 - ${endHour}:00`;
        updateTimeCaptureChart(document.getElementById('datePicker').value);
    });
    
    loadInitialData();
    
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab') + 'Tab';
            switchTab(tabId);
        });
    });
});

function createDailyChart() {
    const dailyData = {};
    rawData.forEach(row => {
        const date = new Date(row[0]);
        const datePart = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        
        const customers = parseInt(row[columnMap['Customers']]) || 0;
        const passersby = parseInt(row[columnMap['Passersby']]) || 0;
        
        if (!dailyData[datePart]) {
            dailyData[datePart] = { customers: 0, passersby: 0 };
        }
        dailyData[datePart].customers += customers;
        dailyData[datePart].passersby += passersby;
    });

    const dates = Object.keys(dailyData).sort();
    const customerData = dates.map(date => dailyData[date].customers);
    const passersByData = dates.map(date => dailyData[date].passersby);
    const captureRateData = dates.map(date => 
        calculateCaptureRate(dailyData[date].customers, dailyData[date].passersby)
    );

    const ctx1 = document.getElementById('trafficChart').getContext('2d');
    if (window.dailyChart) window.dailyChart.destroy();
    
    window.dailyChart = new Chart(ctx1, {
        data: {
            labels: dates,
            datasets: [
                {
                    type: 'bar',
                    label: 'Daily Customers',
                    data: customerData,
                    backgroundColor: 'rgba(47, 118, 34, 0.5)',
                    borderColor: '#2f7622',
                    yAxisID: 'y-customers',
                },
                {
                    type: 'line',
                    label: 'Daily Passersby',
                    data: passersByData,
                    borderColor: '#f39700',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y-passersby',
                },
                {
                    type: 'line',
                    label: 'Capture Rate (%)',
                    data: captureRateData,
                    borderColor: '#c5d469',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y-capture',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        color: function(context) {
                            return getDateColor(context.tick.label);
                        },
                        callback: function(value, index) {
                            const dateStr = this.getLabelForValue(value);
                            const [day, month, year] = dateStr.split('/');
                            const date = new Date(year, month - 1, day);
                            const weekNum = getWeekNumber(date);
                            return [`Week ${weekNum}`, dateStr];
                        }
                    }
                },
                'y-customers': {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Customers'
                    }
                },
                'y-passersby': {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Passersby'
                    }
                },
                'y-capture': {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Capture Rate (%)'
                    },
                    min: 0,
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

function updateGenderPieChart(selectedDate) {
    const [day, month, year] = selectedDate.split('/');
    const dailyGenderData = {
        men: 0,
        women: 0
    };

    rawData.forEach(row => {
        const date = new Date(row[0]);
        const datePart = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        
        if (datePart === selectedDate) {
            dailyGenderData.men += getValue('Men', row);
            dailyGenderData.women += getValue('Women', row);
        }
    });

    const total = dailyGenderData.men + dailyGenderData.women;
    const menPercent = total > 0 ? (dailyGenderData.men / total * 100).toFixed(1) : 0;
    const womenPercent = total > 0 ? (dailyGenderData.women / total * 100).toFixed(1) : 0;

    const ctx = document.getElementById('genderPieChart').getContext('2d');
    
    if (genderPieChart instanceof Chart) {
        genderPieChart.destroy();
    }

    genderPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: [`Men (${menPercent}%)`, `Women (${womenPercent}%)`],
            datasets: [{
                data: [dailyGenderData.men, dailyGenderData.women],
                backgroundColor: [
                    'rgba(47, 118, 34, 0.8)',
                    'rgba(243, 151, 0, 0.8)'
                ],
                borderColor: [
                    '#2f7622',
                    '#f39700'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Gender Distribution'
                },
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label.split(' (')[0]}: ${value.toFixed(1)} (${percentage}%)`;
                        }
                    }
                },
                datalabels: {
                    formatter: (value, ctx) => {
                        const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return percentage + '%';
                    },
                    color: '#fff',
                    font: {
                        weight: 'bold'
                    }
                }
            }
        }
    });
}

function updateHourlyChart() {
    const selectedDate = document.getElementById('datePicker').value;
    const column1 = document.getElementById('column1').value;
    const column2 = document.getElementById('column2').value;
    const showSecondCategory = document.getElementById('showSecondCategory').checked;
    
    if (!selectedDate || rawData.length === 0) return;

    const [day, month, year] = selectedDate.split('/');
    const selectedDateObj = new Date(year, month - 1, day);
    const selectedDayOfWeek = selectedDateObj.getDay();

    const hourlyData = {};
    const weekdayAverages = {};

    rawData.forEach(row => {
        const date = new Date(row[0]);
        const dayOfWeek = date.getDay();
        const hour = date.getHours().toString().padStart(2, '0');

        if (dayOfWeek === selectedDayOfWeek) {
            if (!weekdayAverages[hour]) {
                weekdayAverages[hour] = {
                    value1: [],
                    value2: [],
                    customers: [],
                    passersby: []
                };
            }

            if (column1 === 'CaptureRate') {
                weekdayAverages[hour].customers.push(parseInt(row[columnMap['Customers']]) || 0);
                weekdayAverages[hour].passersby.push(parseInt(row[columnMap['Passersby']]) || 0);
            } else {
                weekdayAverages[hour].value1.push(getValue(column1, row));
            }

            if (column2 === 'CaptureRate') {
                if (!weekdayAverages[hour].customers) {
                    weekdayAverages[hour].customers.push(parseInt(row[columnMap['Customers']]) || 0);
                    weekdayAverages[hour].passersby.push(parseInt(row[columnMap['Passersby']]) || 0);
                }
            } else {
                weekdayAverages[hour].value2.push(getValue(column2, row));
            }
        }

        const datePart = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        if (datePart === selectedDate) {
            const hour = date.getHours().toString().padStart(2, '0');
            if (!hourlyData[hour]) {
                hourlyData[hour] = {
                    value1: getValue(column1, row),
                    value2: getValue(column2, row)
                };
            }
        }
    });

    const averageData = {};
    Object.keys(weekdayAverages).forEach(hour => {
        averageData[hour] = {
            value1: column1 === 'CaptureRate' 
                ? calculateCaptureRate(
                    weekdayAverages[hour].customers.reduce((a, b) => a + b, 0) / weekdayAverages[hour].customers.length,
                    weekdayAverages[hour].passersby.reduce((a, b) => a + b, 0) / weekdayAverages[hour].passersby.length
                )
                : weekdayAverages[hour].value1.reduce((a, b) => a + b, 0) / weekdayAverages[hour].value1.length,
            value2: column2 === 'CaptureRate'
                ? calculateCaptureRate(
                    weekdayAverages[hour].customers.reduce((a, b) => a + b, 0) / weekdayAverages[hour].customers.length,
                    weekdayAverages[hour].passersby.reduce((a, b) => a + b, 0) / weekdayAverages[hour].passersby.length
                )
                : weekdayAverages[hour].value2.reduce((a, b) => a + b, 0) / weekdayAverages[hour].value2.length
        };
    });

    const hours = Object.keys(hourlyData).sort();
    const values1 = hours.map(hour => hourlyData[hour].value1);
    const values2 = hours.map(hour => hourlyData[hour].value2);
    const avgValues1 = hours.map(hour => averageData[hour]?.value1 || 0);
    const avgValues2 = hours.map(hour => averageData[hour]?.value2 || 0);

    const ctx = document.getElementById('hourlyChart').getContext('2d');
    
    if (hourlyChart instanceof Chart) {
        hourlyChart.destroy();
    }
    
    const needsDualAxes = column1 === 'Passersby' || column2 === 'Passersby' || 
                         column1 === 'CaptureRate' || column2 === 'CaptureRate';

    const chartConfig = {
        type: 'line',
        data: {
            labels: hours.map(h => `${h}:00`),
            datasets: [
                {
                    type: 'bar',
                    label: `Average ${column1}`,
                    data: avgValues1,
                    backgroundColor: `rgba(47, 118, 34, 0.5)`,
                    borderColor: '#2f7622',
                    yAxisID: needsDualAxes && showSecondCategory ? 'y1' : 'y'
                },
                {
                    type: 'line',
                    label: column1,
                    data: values1,
                    borderColor: '#2f7622',
                    backgroundColor: 'rgba(47, 118, 34, 0.2)',
                    yAxisID: needsDualAxes && showSecondCategory ? 'y1' : 'y'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Count'
                    }
                }
            }
        }
    };

    if (showSecondCategory) {
        chartConfig.data.datasets.push(
            {
                type: 'bar',
                label: `Average ${column2}`,
                data: avgValues2,
                backgroundColor: `rgba(243, 151, 0, 0.5)`,
                borderColor: '#f39700',
                yAxisID: needsDualAxes ? 'y2' : 'y'
            },
            {
                type: 'line',
                label: column2,
                data: values2,
                borderColor: '#f39700',
                backgroundColor: 'rgba(243, 151, 0, 0.2)',
                yAxisID: needsDualAxes ? 'y2' : 'y'
            }
        );

        if (needsDualAxes) {
            chartConfig.options.scales = {
                y1: {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: column1
                    },
                    min: column1 === 'CaptureRate' ? 0 : undefined
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: column2
                    },
                    min: column2 === 'CaptureRate' ? 0 : undefined,
                    grid: {
                        drawOnChartArea: false
                    }
                }
            };
        }
    }

    hourlyChart = new Chart(ctx, chartConfig);
    updateGenderPieChart(selectedDate);
    updateTimeCaptureChart(selectedDate);
}

function updateWeekdayChart() {
    const selectedDay = parseInt(document.getElementById('weekdaySelect').value);
    
    const hourlyAverages = {};
    
    rawData.forEach(row => {
        const date = new Date(row[0]);
        if (date.getDay() === selectedDay) {
            const hour = date.getHours();
            
            if (!hourlyAverages[hour]) {
                hourlyAverages[hour] = {
                    customers: [],
                    passersby: [],
                    captureRates: []
                };
            }
            
            const customers = parseInt(row[columnMap['Customers']]) || 0;
            const passersby = parseInt(row[columnMap['Passersby']]) || 0;
            const captureRate = calculateCaptureRate(customers, passersby);
            
            hourlyAverages[hour].customers.push(customers);
            hourlyAverages[hour].passersby.push(passersby);
            hourlyAverages[hour].captureRates.push(parseFloat(captureRate));
        }
    });
    
    const hours = Object.keys(hourlyAverages).sort((a,b) => a-b);
    const avgCustomers = hours.map(hour => {
        const sum = hourlyAverages[hour].customers.reduce((a,b) => a+b, 0);
        return sum / hourlyAverages[hour].customers.length;
    });
    const avgPassersby = hours.map(hour => {
        const sum = hourlyAverages[hour].passersby.reduce((a,b) => a+b, 0);
        return sum / hourlyAverages[hour].passersby.length;
    });
    const avgCaptureRate = hours.map(hour => {
        const sum = hourlyAverages[hour].captureRates.reduce((a,b) => a+b, 0);
        return sum / hourlyAverages[hour].captureRates.length;
    });

    const ctx = document.getElementById('weekdayChart').getContext('2d');
    if (window.weekdayChart instanceof Chart) {
        window.weekdayChart.destroy();
    }
    
    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    window.weekdayChart = new Chart(ctx, {
        data: {
            labels: hours.map(h => `${h}:00`),
            datasets: [
                {
                    type: 'bar',
                    label: 'Average Customers',
                    data: avgCustomers,
                    backgroundColor: 'rgba(47, 118, 34, 0.5)',
                    borderColor: '#2f7622',
                    yAxisID: 'y-customers',
                },
                {
                    type: 'line',
                    label: 'Average Passersby',
                    data: avgPassersby,
                    borderColor: '#f39700',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y-passersby',
                },
                {
                    type: 'line',
                    label: 'Average Capture Rate (%)',
                    data: avgCaptureRate,
                    borderColor: '#c5d469',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y-capture',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                'y-customers': {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Customers'
                    }
                },
                'y-passersby': {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Passersby'
                    }
                },
                'y-capture': {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Capture Rate (%)'
                    },
                    min: 0,
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `Average Traffic for ${weekdays[selectedDay]}`
                }
            }
        }
    });
}

function showMessage(message, type) {
    console.log(`${type}: ${message}`);
    const messageDiv = document.getElementById('message');
    if (messageDiv) {
        messageDiv.className = 'message ' + type;
        messageDiv.textContent = message;
    }
}

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });

    document.getElementById(tabId).classList.add('active');
    document.querySelector(`[data-tab="${tabId.replace('Tab', '')}"]`).classList.add('active');
    window.dispatchEvent(new Event('resize'));
}
</script>
</body></html>